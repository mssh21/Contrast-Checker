<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Contrast Checker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
      background: #fff;
      padding: 16px;
    }

    .header {
      margin-bottom: 24px;
      text-align: center;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }

    .header p {
      font-size: 12px;
      color: #666;
    }

    .main-section {
      margin-bottom: 20px;
    }

    .check-button {
      width: 100%;
      padding: 12px 16px;
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 16px;
    }

    .check-button:hover {
      background: #0d7acc;
    }

    .check-button:active {
      background: #0b6fb7;
    }

    .check-button:disabled {
      background: #ddd;
      cursor: not-allowed;
    }

    .results {
      margin-top: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 6px;
      display: none;
    }

    .results.show {
      display: block;
    }

    .results-header {
      font-weight: 600;
      margin-bottom: 12px;
    }

    .result-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .status-pass {
      color: #28a745;
      font-weight: 500;
    }

    .status-fail {
      color: #dc3545;
      font-weight: 500;
    }

    .ratio {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
    }

    .loading {
      display: none;
      text-align: center;
      color: #666;
      margin-top: 16px;
    }

    .error {
      display: none;
      padding: 12px;
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 6px;
      color: #c53030;
      margin-top: 16px;
    }

    .info {
      font-size: 12px;
      color: #666;
      margin-top: 16px;
      padding: 12px;
      background: #f0f7ff;
      border-radius: 6px;
      border-left: 3px solid #18a0fb;
    }

    .highlight-controls {
      margin-top: 16px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-top: 1px solid #dee2e6;
    }

    .highlight-button {
      width: 100%;
      padding: 8px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 8px;
    }

    .highlight-button:hover {
      background: #218838;
    }

    .clear-button {
      background: #6c757d;
    }

    .clear-button:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¨ Contrast Checker</h1>
    <p>ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆæ¯”ã‚’WCAGåŸºæº–ã§ãƒã‚§ãƒƒã‚¯</p>
  </div>

  <div class="main-section">
    <button id="checkButton" class="check-button">
      ğŸ“Š ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    </button>
    
    <div class="info">
      <strong>ä½¿ç”¨æ–¹æ³•:</strong><br>
      1. Figmaã§ãƒ•ãƒ¬ãƒ¼ãƒ ã¾ãŸã¯è¦ç´ ã‚’é¸æŠ<br>
      2. ã€Œã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹<br>
      3. å•é¡Œã®ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒFigmaæ¤œç´¢é¢¨ã«é¸æŠè¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
  </div>

  <div id="loading" class="loading">
    ãƒã‚§ãƒƒã‚¯ä¸­...
  </div>

  <div id="error" class="error"></div>

  <div id="results" class="results">
    <div class="results-header">ãƒã‚§ãƒƒã‚¯çµæœ</div>
    <div id="resultsList"></div>
    
    <div class="highlight-controls">
      <button id="highlightButton" class="highlight-button">
        ğŸ” å•é¡Œã®ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠ
      </button>
      <button id="clearButton" class="highlight-button clear-button">
        âœ¨ é¸æŠã‚’ã‚¯ãƒªã‚¢
      </button>
    </div>
  </div>

  <script>
    let checkResults = [];

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('checkButton').addEventListener('click', function() {
      checkContrast();
    });

    document.getElementById('highlightButton').addEventListener('click', function() {
      highlightFailedTexts();
    });

    document.getElementById('clearButton').addEventListener('click', function() {
      clearHighlights();
    });

    // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    function checkContrast() {
      const button = document.getElementById('checkButton');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const results = document.getElementById('results');

      // UIçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      button.disabled = true;
      button.textContent = 'ãƒã‚§ãƒƒã‚¯ä¸­...';
      loading.style.display = 'block';
      error.style.display = 'none';
      results.classList.remove('show');

      // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      parent.postMessage({ 
        pluginMessage: { 
          type: 'check-contrast' 
        } 
      }, '*');
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆå®Ÿè¡Œ
    function highlightFailedTexts() {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'highlight-failed-texts',
          results: checkResults
        } 
      }, '*');
    }

    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¯ãƒªã‚¢
    function clearHighlights() {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'clear-highlights' 
        } 
      }, '*');
    }

    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
    window.onmessage = function(event) {
      const message = event.data.pluginMessage;
      
      if (message.type === 'check-complete') {
        handleCheckComplete(message.data);
      } else if (message.type === 'check-error') {
        handleCheckError(message.error);
      }
    };

    // ãƒã‚§ãƒƒã‚¯å®Œäº†æ™‚ã®å‡¦ç†
    function handleCheckComplete(data) {
      const button = document.getElementById('checkButton');
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const resultsList = document.getElementById('resultsList');

      // UIçŠ¶æ…‹ã‚’æ›´æ–°
      button.disabled = false;
      button.textContent = 'ğŸ“Š ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯';
      loading.style.display = 'none';

      // çµæœã‚’ä¿å­˜
      checkResults = data.results;

      // çµæœã‚’è¡¨ç¤º
      displayResults(data);
      results.classList.add('show');
    }

    // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
    function handleCheckError(errorMessage) {
      const button = document.getElementById('checkButton');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');

      button.disabled = false;
      button.textContent = 'ğŸ“Š ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯';
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = errorMessage;
    }

    // çµæœã‚’è¡¨ç¤º
    function displayResults(data) {
      const resultsList = document.getElementById('resultsList');
      const { results, totalTexts, passedCount, failedCount } = data;

      let html = '';
      
      // ã‚µãƒãƒªãƒ¼
      html += `<div class="result-item">`;
      html += `<strong>ç·ãƒ†ã‚­ã‚¹ãƒˆæ•°:</strong> ${totalTexts} `;
      html += `<span class="status-pass">é©åˆ: ${passedCount}</span> `;
      html += `<span class="status-fail">éé©åˆ: ${failedCount}</span>`;
      html += `</div>`;

      // å„ãƒ†ã‚­ã‚¹ãƒˆã®è©³ç´°ï¼ˆéé©åˆã®ã‚‚ã®ã®ã¿è¡¨ç¤ºï¼‰
      if (failedCount > 0) {
        const failedResults = results.filter(r => !r.aa);
        html += `<div class="result-item"><strong>å•é¡Œã®ã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ:</strong></div>`;
        
        failedResults.forEach((result, index) => {
          const textPreview = result.text.length > 30 
            ? result.text.substring(0, 30) + '...' 
            : result.text;
          
          html += `<div class="result-item">`;
          html += `${index + 1}. "${textPreview}"`;
          html += `<span class="ratio">${result.ratio}:1</span>`;
          html += ` <span class="status-fail">FAIL</span>`;
          html += `<br><small>å¿…è¦: ${result.isLargeText ? '3:1' : '4.5:1'} ä»¥ä¸Š</small>`;
          html += `</div>`;
        });
      }

      resultsList.innerHTML = html;
    }
  </script>
</body>
</html>